#!/bin/bash

# Fetch visa check card data from Bank of America,
# then submit a piece of mainframe JCL to trigger file pickup

# Set the environment variables
. $HOME/bin/boa-vcc_solar.environment

set -x

cd $inbound_dir
rm ~/.netrc
ln -s ~/.netrc.tsolarin ~/.netrc


echo -e "\ncheck for file "$data_file" at $ftp_host" 
	ftp -v $ftp_host <<EOF1 >ftp_results.$$ 2>&1
	dir
	quit
EOF1

data_ready=`grep -c -e "-AR-.*$data_file" ftp_results.$$`
	if [ $data_ready -eq 0 ]; then
echo "<<ZZZ1

	Apparently there was no Visa check card data to
	download from Bank of America for use by Mileage Plan.  
	Please contact the Bank of America data transfer
	helpdesk at (888) 269-5266 and ask them if the data file 
	for ID ALATESTO and batchid TEST FILE.txt is ready
	for pick up.

	Contact Production Support once you have received
	an answer from the B of A helpdesk.

	cat ftp_results.$$
ZZZ1"
	rm ftp_results.$$
	exit 4
	fi

rm -f ftp_results.$$
	
	if [ $data_ready -ne 1 ]; then 
echo -e "\nthere is more than 1 file in BOA mailbox, notify Production Services.\n"
	exit 4
	fi	

ftp_vendor_get $ftp_host $data_file $boa_file passive bin

echo -e "\nDecrypt file $boa_file"
echo $PGPPASS | gpg --passphrase-fd 0 --batch --decrypt --output $data_file $boa_file
	result=$?
	
	if [ $result -ne 0 ]; then
echo -e "\ninbound $boa_file decrypt problem.  Notify Production support."
	exit 8
	fi

ftp_vendor $ftp_local_host $data_file $data_file "cd mptest/bofaaccrual/consumer"

exit
#leave exit in so no data set is uploaded to MVS but clean out inbound.

#dsn_2mvs mvs $data_file $dataset 

#ftp_jcl $data_jcl mvs

mv $boa_file $inbound_archive/$boa_file.$datestamp

rm -f $data_file

echo -e "\nremove archived files older than +FileAge days"
	find $inbound_archive/$boa_file* -mtime +$FileAge -print |
	while read FILE1
	do
	echo "removing file $FILE1"
	rm -f $FILE1
	done
