
#!/bin/bash

set -x
#this is a stand alone script

export BATCHMODE=yes          # Turn on non-prompted PGP encrypting
export sftp_host=alaskaairsftp@beesftp1.beeline.com
export outbound_dir=$HOME/outbound
export outbound_archive=${outbound_dir}.archive
export inbound_dir=$HOME/inbound
export inbound_archive=${inbound_dir}.archive
#export hcmdir_in=/home/hcmprod/inbound/beeline
export hcmdir_out=/home/hcmprod/outbound/beeline
export datestamp=`/bin/date +%m%d%Y%H%M%S`
export out_file=ALASKAAIR_USER_$datestamp
export tag_file=beeline_outbound.tag
export alert_recipient=dean.liebrich@alaskaair.com
export info_to="dean.liebricha@alaskaair.com"
export errors_to="joanne.gies@alaskaair.com"
export logfile=$HOME/transfer_log
export FileAge=20
export ops=/opt/local/ops_scripts

. /opt/local/ops_scripts/function_lib

cd $hcmdir_out

export data_file=`ls -1 beeline_outbound.csv`

echo -e "\nprocessing $whoami $data_file"

cp $hcmdir_out/$data_file $outbound_dir

cd $outbound_dir

securezip $data_file outbound

echo -e "\nput $data_file to $sftp_host"
	sftp $sftp_host <<PUTDATA >ftp_results.$$
        cd In
	bin
	put $data_file $out_file.csv
        dir
	bye
PUTDATA
	result=$?

	if [ $result -ne 0 ]; then
	echo "FTP put of $data_file to Beeline failed, contact EPS"
	cat ftp_results.$$
	rm ftp_results.$$
	exit 4
	fi

cat ftp_results.$$
rm -f ftp_results.$$

echo -e "\nRemove archived files older than $FileAge days"
find $outbound_archive/* -mtime +$FileAge -print |
	while read FILE1
	do
	echo "removing file $FILE1"
	rm -f $FILE1
	done

data_records=`wc -l $data_file | awk '{print $1}'`
echo -e "\n$datestamp: there were $data_records records sent to beeline" 

echo -e "\nRemove temp files"
rm -f $data_file $hcmdir_out/$data_file $hcmdir_out/$tag_file
